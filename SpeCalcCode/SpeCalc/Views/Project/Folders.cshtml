@model IEnumerable<SpeCalcDataAccessLayer.ProjectModels.ProjectFolderModel>

<ul class="list-unstyled">
    @foreach (var fold in Model)
    {
        @Html.Partial("Folder", fold)
    }
</ul>

<script>
    $(function() {
        //loadFiles();
        
        $("[id^=files-cont-]").on("hide.bs.collapse", function () {
            var fid = $(this).attr('fid');
            var $caret = $('#folder-' + fid).find('[name=caret]');
            $caret.addClass('fa-folder');
            $caret.removeClass('fa-folder-open');
            //$caret.addClass('fa-caret-right');
            //$caret.removeClass('fa-caret-down');
        });
        $("[id^=files-cont-]").on("show.bs.collapse", function () {
            var fid = $(this).attr('fid');
            var $caret = $('#folder-' + fid).find('[name=caret]');
            $caret.removeClass('fa-folder');
            $caret.addClass('fa-folder-open');
            //$caret.removeClass('fa-caret-right');
            //$caret.addClass('fa-caret-down');
            var pid = $(this).attr('pid');
            loadFiles(fid, pid);
        });

        $('[id^=uploadFile-folder-]').on('change', function(e) {
            var $this = $(this);
            var files = e.target.files;
            var fid = $this.attr('fid');
            var pid = $this.attr('pid');
            if (files.length > 0) {
                if (window.FormData !== undefined) {
                    var data = new FormData();
                    for (var x = 0; x < files.length; x++) {
                        data.append("file" + x, files[x]);
                    }
                    showSpinnerAppendAndDisable($this.parent('.btn'));
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("UploadFile")?pid='+pid+'&fid='+fid,
                        data: data,//{pid:pid, fid:fid},
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            loadFiles(fid, pid);
                            hideSpinnerAndEnabled();
                            $this.val('');
                        },
                        error: function(xhr, status, p3, p4) {
                            var err = "Error " + " " + status + " " + p3 + " " + p4;
                            if (xhr.responseText && xhr.responseText[0] == "{")
                                err = JSON.parse(xhr.responseText).Message;
                            console.log(err);
                            alert('Ошибка при сохранении файла!');
                            hideSpinnerAndEnabled();
                            $this.val('');
                        }
                    });
                } else {
                    alert("This browser doesn't support HTML5 file uploads!");
                }
            }
        });
    });

    function loadFiles(fid, pid) {
        var $cont = $('#files-' + fid);
        $cont.html('');
        showSpinner($cont);
        $.ajax({
            url:'@Url.Action("GetFolderFiles")',
            method:'GET',
            data: { fid: fid, pid: pid },
            success: function (html) {
                $cont.html(html);
                $('[name="deleteFile"]').click(deleteFile);
                hideSpinner($cont);
            },
            error:function(data) {
                alert('Ошибка при загрузке файлов папки!');
                console.log(data);
                hideSpinner($cont);
            }
        });
    }

    function deleteFile() {
        if (!confirm('Вы действительно хотите удалить файл?'))return;
        var $this = $(this);
        var fguid = $this.attr('fguid');
        var pid = $this.attr('pid');
        $.ajax({
            url: '@Url.Action("DeleteFile")',
            method: 'POST',
            data: { guid: fguid, pid: pid },
            success: function() {
                var $cont = $('ul[name=folderFiles]:has([name="deleteFile"][fguid=' + fguid + '])');
                var fid = $cont.attr('fid');
                var pid = $cont.attr('pid');
                loadFiles(fid, pid);
            },
            error: function(data) {
                pathSegTypeAsLetter('Ошибка при удалении файла!');
                console.log(data);

            }
        });
    }
</script>